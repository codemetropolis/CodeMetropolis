<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../../jacoco-resources/report.gif" type="image/gif"/><title>BuildableTree.java</title><link rel="stylesheet" href="../../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../../index.html" class="el_report">Merged (Apr 21, 2018 5:41:32 PM)</a> &gt; <a href="../../index.html" class="el_group">codemetropolis-toolchain-commons</a> &gt; <a href="../index.html" class="el_bundle">src/main/java</a> &gt; <a href="index.source.html" class="el_package">codemetropolis.toolchain.commons.cmxml</a> &gt; <span class="el_source">BuildableTree.java</span></div><h1>BuildableTree.java</h1><pre class="source lang-java linenums">package codemetropolis.toolchain.commons.cmxml;

import java.io.File;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.List;

import javax.xml.parsers.DocumentBuilder;
import javax.xml.parsers.DocumentBuilderFactory;
import javax.xml.transform.OutputKeys;
import javax.xml.transform.Transformer;
import javax.xml.transform.TransformerFactory;
import javax.xml.transform.dom.DOMSource;
import javax.xml.transform.stream.StreamResult;

import org.w3c.dom.Document;
import org.w3c.dom.Element;
import org.w3c.dom.Node;
import org.w3c.dom.NodeList;

import codemetropolis.toolchain.commons.cmxml.Buildable.Type;
import codemetropolis.toolchain.commons.cmxml.exceptions.CmxmlReaderException;
import codemetropolis.toolchain.commons.cmxml.exceptions.CmxmlWriterException;
import codemetropolis.toolchain.commons.util.FileUtils;
import codemetropolis.toolchain.commons.util.Resources;

public class BuildableTree {
	
	public class Iterator {

<span class="nc" id="L31">		private List&lt;Buildable&gt; temp = new ArrayList&lt;Buildable&gt;();</span>
<span class="nc" id="L32">		private int index = 0;</span>
		
<span class="nc" id="L34">		Iterator() {</span>
<span class="nc" id="L35">			temp.add(root);</span>
<span class="nc" id="L36">		}</span>
		
		public int getIndex() {
<span class="nc" id="L39">			return index;</span>
		}
		
		public boolean hasNext() {
<span class="nc bnc" id="L43" title="All 2 branches missed.">			return !temp.isEmpty();</span>
		}

		public Buildable next() {
<span class="nc" id="L47">			Buildable next = temp.remove(0);</span>
<span class="nc" id="L48">			temp.addAll(0, Arrays.asList(next.getChildren()));</span>
<span class="nc" id="L49">			++index;</span>
<span class="nc" id="L50">			return next;</span>
		}
		
	}
	
	private Buildable root;
	
	public BuildableTree() {
<span class="nc" id="L58">		this(null);</span>
<span class="nc" id="L59">	}</span>
	
<span class="nc" id="L61">	public BuildableTree(Buildable root) {</span>
<span class="nc" id="L62">		this.root = root;</span>
<span class="nc" id="L63">	}</span>
	
	public Buildable getRoot() {
<span class="nc" id="L66">		return root;</span>
	}
	
	public Iterator iterator() {
<span class="nc" id="L70">		return new Iterator();</span>
	}
	
	public int size() {
<span class="nc" id="L74">		return getBuildables().size();</span>
	}
	
	public List&lt;Buildable&gt; getBuildables() {
<span class="nc" id="L78">		List&lt;Buildable&gt; buildables = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L79">		buildables.add(root);</span>
<span class="nc" id="L80">		buildables.addAll(root.getDescendants());</span>
<span class="nc" id="L81">		return buildables;</span>
	}
	
	public Buildable getBuildable(String id) {
<span class="nc" id="L85">		return getBuildableFromDescendants(root, id);</span>
	}
	
	private Buildable getBuildableFromDescendants(Buildable b, String id) {
<span class="nc bnc" id="L89" title="All 2 branches missed.">		if(b.getId().equals(id)) return b;</span>
<span class="nc bnc" id="L90" title="All 2 branches missed.">		for(Buildable c : b.getChildren())</span>
<span class="nc bnc" id="L91" title="All 2 branches missed.">			if(getBuildableFromDescendants(c, id) != null) return getBuildableFromDescendants(c, id);</span>
<span class="nc" id="L92">		return null;</span>
	}
	
	public Buildable[] findBuildables(int x, int z) {
<span class="nc" id="L96">		List&lt;Buildable&gt; result = new ArrayList&lt;Buildable&gt;();</span>
<span class="nc" id="L97">		Iterator it = iterator();</span>
<span class="nc bnc" id="L98" title="All 2 branches missed.">		while(it.hasNext()) {</span>
<span class="nc" id="L99">			Buildable b = it.next();</span>
<span class="nc bnc" id="L100" title="All 2 branches missed.">			if(b.isOverlapping(x, z)) {</span>
<span class="nc" id="L101">				result.add(b);</span>
			}
		}
<span class="nc" id="L104">		return result.toArray(new Buildable[result.size()]);</span>
	}
	
	public void loadFromFile(String path) throws CmxmlReaderException {
		try {
<span class="nc" id="L109">			root = null;</span>
<span class="nc" id="L110">			DocumentBuilderFactory dbFactory = DocumentBuilderFactory.newInstance();;</span>
<span class="nc" id="L111">			DocumentBuilder dBuilder = dbFactory.newDocumentBuilder();</span>
<span class="nc" id="L112">			File xmlFile = new File(path);</span>
<span class="nc" id="L113">			Document doc = dBuilder.parse(xmlFile);</span>
<span class="nc" id="L114">			doc.getDocumentElement().normalize();</span>
<span class="nc" id="L115">			NodeList nList = doc.getElementsByTagName(&quot;buildable&quot;);</span>
	 
<span class="nc bnc" id="L117" title="All 2 branches missed.">			for (int temp = 0; temp &lt; nList.getLength(); temp++) {</span>
<span class="nc" id="L118">				Node nNode = nList.item(temp);</span>
<span class="nc bnc" id="L119" title="All 2 branches missed.">				if (nNode.getNodeType() == Node.ELEMENT_NODE) {</span>
				
<span class="nc" id="L121">					Element eElement = (Element) nNode;</span>
					
<span class="nc" id="L123">					Type type = null;</span>
<span class="nc bnc" id="L124" title="All 16 branches missed.">					switch(eElement.getAttribute(&quot;type&quot;)) {</span>
<span class="nc" id="L125">						case &quot;ground&quot;: type = Type.GROUND;</span>
<span class="nc" id="L126">						break;</span>
<span class="nc" id="L127">						case &quot;garden&quot;: type = Type.GARDEN;</span>
<span class="nc" id="L128">						break;</span>
<span class="nc" id="L129">						case &quot;floor&quot;: type = Type.FLOOR;</span>
<span class="nc" id="L130">						break;</span>
<span class="nc" id="L131">						case &quot;cellar&quot;: type = Type.CELLAR;</span>
<span class="nc" id="L132">						break;</span>
<span class="nc" id="L133">						case &quot;container&quot;: type = Type.CONTAINER;</span>
						break;
					}
					
					Point position;
<span class="nc bnc" id="L138" title="All 4 branches missed.">					if(eElement.getElementsByTagName(&quot;position&quot;).item(0) != null &amp;&amp; eElement.getElementsByTagName(&quot;position&quot;).item(0).getParentNode() == nNode) {</span>
<span class="nc" id="L139">						position = new Point(</span>
<span class="nc" id="L140">								Integer.parseInt(((Element)eElement.getElementsByTagName(&quot;position&quot;).item(0)).getAttribute(&quot;x&quot;)),</span>
<span class="nc" id="L141">								Integer.parseInt(((Element)eElement.getElementsByTagName(&quot;position&quot;).item(0)).getAttribute(&quot;y&quot;)),</span>
<span class="nc" id="L142">								Integer.parseInt(((Element)eElement.getElementsByTagName(&quot;position&quot;).item(0)).getAttribute(&quot;z&quot;))</span>
								);
<span class="nc" id="L144">					} else {</span>
<span class="nc" id="L145">						position = new Point();</span>
					}
			
					Point size;
<span class="nc bnc" id="L149" title="All 4 branches missed.">					if(eElement.getElementsByTagName(&quot;size&quot;).item(0) != null &amp;&amp; eElement.getElementsByTagName(&quot;size&quot;).item(0).getParentNode() == nNode) {</span>
<span class="nc" id="L150">						size = new Point(</span>
<span class="nc" id="L151">							Integer.parseInt(((Element)eElement.getElementsByTagName(&quot;size&quot;).item(0)).getAttribute(&quot;x&quot;)),</span>
<span class="nc" id="L152">							Integer.parseInt(((Element)eElement.getElementsByTagName(&quot;size&quot;).item(0)).getAttribute(&quot;y&quot;)),</span>
<span class="nc" id="L153">							Integer.parseInt(((Element)eElement.getElementsByTagName(&quot;size&quot;).item(0)).getAttribute(&quot;z&quot;))</span>
							);
<span class="nc" id="L155">					} else {</span>
<span class="nc" id="L156">						size = new Point();</span>
					}
					
<span class="nc" id="L159">					Buildable b = new Buildable(</span>
<span class="nc" id="L160">							eElement.getAttribute(&quot;id&quot;),</span>
<span class="nc" id="L161">							eElement.getAttribute(&quot;name&quot;),</span>
<span class="nc" id="L162">							type,</span>
<span class="nc" id="L163">							position,</span>
<span class="nc" id="L164">							size</span>
							);
					
<span class="nc" id="L167">					NodeList attributeNodes = eElement.getElementsByTagName(&quot;attributes&quot;).item(0).getChildNodes();</span>
					
<span class="nc bnc" id="L169" title="All 2 branches missed.">					for(int i = 1; attributeNodes.item(i) != null; i += 2) {</span>
<span class="nc" id="L170">						b.addAttribute(</span>
<span class="nc" id="L171">								((Element)attributeNodes.item(i)).getAttribute(&quot;name&quot;),</span>
<span class="nc" id="L172">								((Element)attributeNodes.item(i)).getAttribute(&quot;value&quot;)</span>
						);
					}
					
<span class="nc bnc" id="L176" title="All 2 branches missed.">					if(!nNode.getParentNode().getNodeName().equals(&quot;buildables&quot;)) {</span>
						// Adds current buildable to parent's &quot;children&quot; list 
<span class="nc" id="L178">						Element parentElement = (Element)nNode.getParentNode().getParentNode();</span>
<span class="nc" id="L179">						getBuildable(parentElement.getAttribute(&quot;id&quot;)).addChild(b);</span>
<span class="nc" id="L180">					} else {</span>
<span class="nc" id="L181">						root = b;</span>
					}
				}
			}
<span class="nc" id="L185">		} catch(Exception e) {</span>
<span class="nc" id="L186">			throw new CmxmlReaderException(e);</span>
		}
<span class="nc" id="L188">	}</span>
	
	public void writeToFile(String filePath, String from, String to, String version) throws CmxmlWriterException {
<span class="nc" id="L191">		writeToFile(filePath, from, to, version, true);</span>
<span class="nc" id="L192">	}</span>
	
	public void writeToFile(String filePath, String from, String to, String version, boolean recursive) throws CmxmlWriterException  {
		try {
<span class="nc" id="L196">			FileUtils.createContainingDirs(filePath);</span>
<span class="nc" id="L197">			DocumentBuilderFactory docFactory = DocumentBuilderFactory.newInstance();</span>
<span class="nc" id="L198">			DocumentBuilder docBuilder = docFactory.newDocumentBuilder();</span>
<span class="nc" id="L199">			Document doc = docBuilder.newDocument();</span>
<span class="nc" id="L200">			Element rootElement = doc.createElement(&quot;buildables&quot;);</span>
<span class="nc" id="L201">			rootElement.setAttribute(&quot;from&quot;, from);</span>
<span class="nc" id="L202">			rootElement.setAttribute(&quot;to&quot;, to);</span>
<span class="nc" id="L203">			rootElement.setAttribute(&quot;version&quot;, version);</span>
<span class="nc" id="L204">			doc.appendChild(rootElement);</span>
			
<span class="nc bnc" id="L206" title="All 2 branches missed.">			if(recursive) {</span>
<span class="nc" id="L207">				rootElement.appendChild(root.toXmlElement(doc, true));</span>
<span class="nc" id="L208">			} else {</span>
<span class="nc" id="L209">				Iterator it = iterator();</span>
<span class="nc bnc" id="L210" title="All 2 branches missed.">				while(it.hasNext()) {</span>
<span class="nc" id="L211">					Buildable b = it.next();</span>
<span class="nc" id="L212">					rootElement.appendChild(b.toXmlElement(doc, false));</span>
				}
				
<span class="nc" id="L215">				Iterator it2 = iterator();</span>
<span class="nc bnc" id="L216" title="All 2 branches missed.">				while(it2.hasNext()) {</span>
<span class="nc" id="L217">					Buildable b = it2.next();</span>
<span class="nc" id="L218">					Buildable parent = b.getParent();</span>
<span class="nc bnc" id="L219" title="All 2 branches missed.">					if(parent != null) {</span>
<span class="nc" id="L220">						Element parentElement = doc.getElementById(parent.getId());</span>
<span class="nc" id="L221">						Element buildableElement = doc.getElementById(b.getId());</span>
<span class="nc" id="L222">						parentElement.getElementsByTagName(&quot;children&quot;).item(0).appendChild(buildableElement);</span>
					}
				}
			}
			
<span class="nc" id="L227">			TransformerFactory transformerFactory = TransformerFactory.newInstance();</span>
<span class="nc" id="L228">			Transformer transformer = transformerFactory.newTransformer();</span>
<span class="nc" id="L229">			DOMSource source = new DOMSource(doc);</span>
<span class="nc" id="L230">			StreamResult result = new StreamResult(new File(filePath));</span>
<span class="nc" id="L231">			transformer.setOutputProperty(OutputKeys.INDENT, &quot;yes&quot;);</span>
<span class="nc" id="L232">			transformer.setOutputProperty(&quot;{http://xml.apache.org/xslt}indent-amount&quot;, &quot;4&quot;);</span>
<span class="nc" id="L233">			transformer.transform(source, result);</span>
<span class="nc" id="L234">		} catch ( Exception e) {</span>
<span class="nc" id="L235">			throw new CmxmlWriterException(Resources.get(&quot;cmxml_writer_error&quot;), e);</span>
		}
<span class="nc" id="L237">	}</span>
	
	@Override
	public String toString() {
<span class="nc" id="L241">		return &quot;&lt;buildables&gt;\n&quot;</span>
<span class="nc" id="L242">				+ root.toString(1, false)</span>
<span class="nc" id="L243">				+ &quot;&lt;/buildables&gt;&quot;;</span>
	}

	public String toEscapedString(String from, String to, String version) {
<span class="nc" id="L247">		String str = &quot;&lt;buildables from=\&quot;&quot; + from + &quot;\&quot; to=\&quot;&quot; + to + &quot;\&quot; version=\&quot;&quot; + &quot;1.0&quot; + &quot;\&quot;&gt;\n&quot;</span>
<span class="nc" id="L248">				+ root.toString(1, true)</span>
<span class="nc" id="L249">				+ &quot;&lt;/buildables&gt;&quot;;</span>
<span class="nc" id="L250">		return str;</span>
	}
	
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.7.9.201702052155</span>Merged (Apr 21, 2018 5:41:32 PM)</div></body></html>
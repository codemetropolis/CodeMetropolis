<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../../jacoco-resources/report.gif" type="image/gif"/><title>RectanglePacker.java</title><link rel="stylesheet" href="../../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../../index.html" class="el_report">Merged (Apr 21, 2018 5:41:32 PM)</a> &gt; <a href="../../index.html" class="el_group">codemetropolis-toolchain-placing</a> &gt; <a href="../index.html" class="el_bundle">src/main/java</a> &gt; <a href="index.source.html" class="el_package">codemetropolis.toolchain.placing.layout.pack</a> &gt; <span class="el_source">RectanglePacker.java</span></div><h1>RectanglePacker.java</h1><pre class="source lang-java linenums">/*
 * Copyright (c) 2007, Ryan McNally All rights reserved.
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions
 * are met: Redistributions of source code must retain the above
 * copyright notice, this list of conditions and the following
 * disclaimer. Redistributions in binary form must reproduce the above
 * copyright notice, this list of conditions and the following
 * disclaimer in the documentation and/or other materials provided
 * with the distribution. Neither the name of the &lt;ORGANIZATION&gt; nor
 * the names of its contributors may be used to endorse or promote
 * products derived from this software without specific prior written
 * permission. THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND
 * CONTRIBUTORS &quot;AS IS&quot; AND ANY EXPRESS OR IMPLIED WARRANTIES,
 * INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF
 * MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
 * DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS
 * BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY,
 * OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO,
 * PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR
 * PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY
 * OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE
 * USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH
 * DAMAGE.
 */

package codemetropolis.toolchain.placing.layout.pack;

import java.util.List;

/**
 * Tries to pack rectangles as tightly as possible. An implementation of the
 * algorithm described at http://www.blackpawn.com/texts/lightmaps/default.html
 * 
 * @author ryanm
 * @param &lt;P&gt;
 *            The type of items to be held
 */
public class RectanglePacker&lt;P&gt; {

  /**
   * Determines the outcome of a rectangle-fitting test
   * 
   * @author ryanm
   */
<span class="nc" id="L47">  private static enum Fit {</span>
    /**
     * Indicates that the rectangle did not fit
     */
<span class="nc" id="L51">    FAIL,</span>
    /**
     * Indicates that the rectangle fitted perfectly
     */
<span class="nc" id="L55">    PERFECT,</span>
    /**
     * Indicates that the rectangle fitted with room to spare
     */
<span class="nc" id="L59">    FIT</span>
  };

  private Node root;

  /**
   * The border to leave around rectangles
   */
<span class="nc" id="L67">  private int border = 0;</span>

  /**
   * Builds a new {@link RectanglePacker}
   * 
   * @param width
   *            The width of the space available to pack into
   * @param height
   *            The height of the space available to pack into
   * @param border
   *            The border to preserve between packed items
   */
<span class="nc" id="L79">  public RectanglePacker(int width, int height, int border) {</span>
<span class="nc" id="L80">    root = new Node(new Rectangle(0, 0, width, height));</span>
<span class="nc" id="L81">    this.border = border;</span>
<span class="nc" id="L82">  }</span>

  /**
   * Builds a list of all {@link Rectangle}s in the tree, for debugging
   * purposes
   * 
   * @param rectangles
   *            The list to add the tree's {@link Rectangle}s to
   */
  public void inspectRectangles(List&lt;Rectangle&gt; rectangles) {
<span class="nc" id="L92">    root.getRectangles(rectangles);</span>
<span class="nc" id="L93">  }</span>

  /**
   * Finds the {@link Rectangle} where an item is stored
   * 
   * @param item
   *            The item to search for
   * @return The {@link Rectangle} where that item resides, or null if not
   *         found
   */
  public Rectangle findRectangle(P item) {
<span class="nc" id="L104">    return root.findRectange(item);</span>
  }

  /**
   * Clears the packer of all items
   */
  public void clear() {
<span class="nc" id="L111">    root = new Node(root.rect);</span>
<span class="nc" id="L112">  }</span>

  /**
   * Attempts to pack an item of the supplied dimensions
   * 
   * @param width
   *            The width of the item
   * @param height
   *            The height of the item
   * @param o
   *            The item to pack
   * @return The packed location, or null if it will not fit.
   */
  public Rectangle insert(int width, int height, P o) {
<span class="nc" id="L126">    Node n = root.insert(width + 2 * border, height + 2 * border, o);</span>

<span class="nc bnc" id="L128" title="All 2 branches missed.">    if (n != null) {</span>
<span class="nc" id="L129">      Rectangle r = new Rectangle(n.rect.x + border, n.rect.y + border,</span>
<span class="nc" id="L130">          n.rect.width - 2 * border, n.rect.height - 2 * border);</span>
<span class="nc" id="L131">      return r;</span>
    } else {
<span class="nc" id="L133">      return null;</span>
    }
  }

  /**
   * Removes an item from the tree, consolidating the space if possible. The
   * space can easily become fragmented, so don't rely on this to work as
   * cleverly as you would like.
   * 
   * @param o
   *            the item to remove
   * @return &lt;code&gt;true&lt;/code&gt; if the item was found, false otherwise
   */
  public boolean remove(P o) {
<span class="nc" id="L147">    return root.remove(o);</span>
  }

  /**
   * Gets the width of this packer
   * 
   * @return the width of this packer
   */
  public int getWidth() {
<span class="nc" id="L156">    return root.rect.width;</span>
  }

  /**
   * Gets the height of this packer
   * 
   * @return The height of this packer
   */
  public int getHeight() {
<span class="nc" id="L165">    return root.rect.height;</span>
  }

<span class="nc bnc" id="L168" title="All 2 branches missed.">  private class Node {</span>
    private Rectangle rect;

<span class="nc" id="L171">    private P occupier = null;</span>

<span class="nc" id="L173">    private Node left = null;</span>

<span class="nc" id="L175">    private Node right = null;</span>

<span class="nc" id="L177">    private Node(Rectangle r) {</span>
<span class="nc" id="L178">      this.rect = r;</span>
<span class="nc" id="L179">    }</span>

    private Rectangle findRectange(P item) {
<span class="nc bnc" id="L182" title="All 2 branches missed.">      if (isLeaf()) {</span>
<span class="nc bnc" id="L183" title="All 2 branches missed.">        if (item == occupier) {</span>
<span class="nc" id="L184">          return rect;</span>
        } else {
<span class="nc" id="L186">          return null;</span>
        }
      } else {
<span class="nc" id="L189">        Rectangle l = left.findRectange(item);</span>

<span class="nc bnc" id="L191" title="All 2 branches missed.">        if (l != null) {</span>
<span class="nc" id="L192">          return l;</span>
        } else {
<span class="nc" id="L194">          return right.findRectange(item);</span>
        }
      }
    }

    private Node insert(int width, int height, P o) {
<span class="nc bnc" id="L200" title="All 2 branches missed.">      if (!isLeaf()) {</span>
<span class="nc" id="L201">        Node r = left.insert(width, height, o);</span>

<span class="nc bnc" id="L203" title="All 2 branches missed.">        if (r == null) {</span>
<span class="nc" id="L204">          r = right.insert(width, height, o);</span>
        }

<span class="nc" id="L207">        return r;</span>
      } else {
<span class="nc bnc" id="L209" title="All 2 branches missed.">        if (occupier != null) {</span>
<span class="nc" id="L210">          return null;</span>
        }

<span class="nc" id="L213">        Fit fit = fits(width, height);</span>

<span class="nc bnc" id="L215" title="All 4 branches missed.">        switch (fit) {</span>
        case FAIL:
<span class="nc" id="L217">          return null;</span>
        case PERFECT:
<span class="nc" id="L219">          occupier = o;</span>
<span class="nc" id="L220">          return this;</span>
        case FIT:
<span class="nc" id="L222">          split(width, height);</span>
          break;
        }

<span class="nc" id="L226">        return left.insert(width, height, o);</span>
      }
    }

    private boolean isLeaf() {
<span class="nc bnc" id="L231" title="All 2 branches missed.">      return left == null;</span>
    }

    /**
     * Determines if this node contains an item, even many levels below
     * 
     * @return &lt;code&gt;true&lt;/code&gt; if this node or any of it's descendants
     *         holds an item
     */
    private boolean isOccupied() {
<span class="nc bnc" id="L241" title="All 4 branches missed.">      return occupier != null || !isLeaf();</span>
    }

    /**
     * Removes an item, and consolidates the tree if possible
     * 
     * @param o
     *            the item to remove
     * @return &lt;code&gt;true&lt;/code&gt; if the item was found, &lt;code&gt;false&lt;/code&gt;
     *         otherwise
     */
    private boolean remove(P o) {
<span class="nc bnc" id="L253" title="All 2 branches missed.">      if (isLeaf()) {</span>
<span class="nc bnc" id="L254" title="All 2 branches missed.">        if (occupier == o) {</span>
<span class="nc" id="L255">          occupier = null;</span>

<span class="nc" id="L257">          return true;</span>
        }
<span class="nc" id="L259">        return false;</span>
      } else {
<span class="nc" id="L261">        boolean found = left.remove(o);</span>
<span class="nc bnc" id="L262" title="All 2 branches missed.">        if (!found) {</span>
<span class="nc" id="L263">          found = right.remove(o);</span>
        }

<span class="nc bnc" id="L266" title="All 2 branches missed.">        if (found) {</span>
<span class="nc bnc" id="L267" title="All 4 branches missed.">          if (!left.isOccupied() &amp;&amp; !right.isOccupied()) {</span>
<span class="nc" id="L268">            left = null;</span>
<span class="nc" id="L269">            right = null;</span>
          }
        }

<span class="nc" id="L273">        return found;</span>
      }
    }

    private void split(int width, int height) {
<span class="nc" id="L278">      int dw = rect.width - width;</span>
<span class="nc" id="L279">      int dh = rect.height - height;</span>

<span class="nc bnc" id="L281" title="All 4 branches missed.">      assert dw &gt;= 0;</span>
<span class="nc bnc" id="L282" title="All 4 branches missed.">      assert dh &gt;= 0;</span>

      Rectangle r, l;
<span class="nc bnc" id="L285" title="All 2 branches missed.">      if (dw &gt; dh) {</span>
<span class="nc" id="L286">        l = new Rectangle(rect.x, rect.y, width, rect.height);</span>

<span class="nc" id="L288">        r = new Rectangle(l.x + width, rect.y, rect.width - width,</span>
            rect.height);
      } else {
<span class="nc" id="L291">        l = new Rectangle(rect.x, rect.y, rect.width, height);</span>

<span class="nc" id="L293">        r = new Rectangle(rect.x, l.y + height, rect.width, rect.height</span>
            - height);
      }

<span class="nc" id="L297">      left = new Node(l);</span>
<span class="nc" id="L298">      right = new Node(r);</span>
<span class="nc" id="L299">    }</span>

    private Fit fits(int width, int height) {
<span class="nc bnc" id="L302" title="All 4 branches missed.">      if (width &lt;= rect.width &amp;&amp; height &lt;= rect.height) {</span>
<span class="nc bnc" id="L303" title="All 4 branches missed.">        if (width == rect.width &amp;&amp; height == rect.height) {</span>
<span class="nc" id="L304">          return Fit.PERFECT;</span>
        } else {
<span class="nc" id="L306">          return Fit.FIT;</span>
        }
      }

<span class="nc" id="L310">      return Fit.FAIL;</span>
    }

    private void getRectangles(List&lt;Rectangle&gt; rectangles) {
<span class="nc" id="L314">      rectangles.add(rect);</span>

<span class="nc bnc" id="L316" title="All 2 branches missed.">      if (!isLeaf()) {</span>
<span class="nc" id="L317">        left.getRectangles(rectangles);</span>
<span class="nc" id="L318">        right.getRectangles(rectangles);</span>
      }
<span class="nc" id="L320">    }</span>
  }

  /**
   * Yet another Rectangle class. Only here to remove dependencies on
   * awt/lwjgl/etc
   * 
   * @author ryanm
   */
  public static class Rectangle {
    /**
     * 
     */
    public final int x;

    /**
     * 
     */
    public final int y;

    /**
     * 
     */
    public final int width;

    /**
     * 
     */
    public final int height;

<span class="nc" id="L350">    private Rectangle(int x, int y, int width, int height) {</span>
<span class="nc" id="L351">      this.x = x;</span>
<span class="nc" id="L352">      this.y = y;</span>
<span class="nc" id="L353">      this.width = width;</span>
<span class="nc" id="L354">      this.height = height;</span>
<span class="nc" id="L355">    }</span>

<span class="nc" id="L357">    private Rectangle(Rectangle r) {</span>
<span class="nc" id="L358">      this.x = r.x;</span>
<span class="nc" id="L359">      this.y = r.y;</span>
<span class="nc" id="L360">      this.width = r.width;</span>
<span class="nc" id="L361">      this.height = r.height;</span>
<span class="nc" id="L362">    }</span>

    @Override
    public String toString() {
<span class="nc" id="L366">      return &quot;[ &quot; + x + &quot;, &quot; + y + &quot;, &quot; + width + &quot;, &quot; + height + &quot; ]&quot;;</span>
    }
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.7.9.201702052155</span>Merged (Apr 21, 2018 5:41:32 PM)</div></body></html>